In recent years, developments in both algorithms and hardware (in particular 
GPGPUs) have led to increasing interest in the use of molecular simulation to 
estimate the strength of macromolecular binding free energies \cite{DeVivo2016}. 
The same molecular simulation technologies that can be employed both in the
design new therapeutics and to investigate the origins of drug resistance in 
pathologies such as cancer and HIV. 

Creating simulation protocols which have well defined uncertainty and produce
statistically meaningful results represents a significant computational challenge. 
Furthermore, it is highly likely that differences among investigated systems will 
demand different protocols and that changes may be requires as studies progress. 
For example, drug design programmes often require the rapid screening of thousands 
of candidate compounds to filter out the worst binders before using more sensitive 
methods to refine the structure. 
Not all changes induced in protein shape or behavior are local to the drug binding 
site and, in some cases, simulation protocols will need to adjust to account for 
complex interactions between drugs and their targets within individual studies.

For molecular simulations to truly influence decison making in industrial and 
clinical settings, the dual challenges of
scale (thousands of concurrent multi-stage pipelines) and sophistication
(adaptive selection of binding affinity protocols based upon system behaviour and statistical uncertainty) will need to be tackled. 
Tools that facilitate the scalable and automated computation of varied binding 
free energy calculations on high-performance computing resources are necessary. 
To achieve that goal, we introduce the High-Throughput Binding Affinity Calculator 
(HTBAC), which provides a domain specific interface to leverage recent advances in abstracting 
the relatonships between building blocks in workflow systems to facilitate the building 
and automation of rapid and accurate calculation of binding affinities.
We demonstrate how HTBAC scales almost perfectly to hundreds of concurrent
pipelines of binding affinity calculations on a leadership class machine. 
This permits the rapid time-to-solution that is essentially invariant of the size
of candidate ligands as well as the type and number of protocols concurrently
employed.

In this work we explore the use of HTBAC in a prototypical exploration of novel 
compounds binding to a target protein.
In this case we look to reproduce a collaboration run between UCL and GlaxoSmithKline 
to study a congeneric series of drug candidates binding to the BRD4 protein (inhibitors 
of which have shown promising preclinical efficacy in pathologies ranging from cancer to
inflammation)~\cite{Wan2017brd4}.
This study compared two different protocols, known as TIES and ESMACS, both based on an 
ensemble simulation philosophy.
In this appraoch multiple simulations are executed based on the same input system description, 
providing enhanced sampling and reduced time to completion.
TIES is based on rigourous, but computationally expensive, calculations of relative free
energies (i.e. results provide a comparison between two drugs).
ESMACS, in contrast, provides absolute binding free energies at low computational cost, 
but to achieve this coarse grains many of the details of the system being studied.
The results of the simplifications employed by ESMACS is that its performance is heavily 
system dependent.
In the real world application of these technologies, drug design 
projects have limited resources and must make trade-offs between the needs for rigour
and coverage of a wide range of chemical space. 
This means that many projects will combine the use of both protocols and in this work we 
demonstrate the use of HT-BAC to adaptively run both protocols, including mixed protocol runs.
Both protocols can involve the running sets of simulations which require very different levels 
of computational power.
We demonstrate how HTBAC can reallocate cores from completed (small, ligand only) simulations 
to ongoing simulations (of the protein-ligand complex).
This is the first step to providing more flexible resource reallocations schemes where 
resources can be moved between simulations run using different protocols or systems, 
for example if convergence of the binding affinity has been reached by one but not another
simulation.
This adaptability makes it easier to manage complex programmes where efficient use of 
resources is required in order to achieve a time to completion of studies comparable 
to those of high throughput chemistry.

In the next section, we review previous work using ensemble molecular dynamics and outline 
the challenges faced in bringing this approach up to extreme scale.
In Section 3, we discuss how HTBAC has been designed and implemented in order to meet the 
computational challenges associated with the scalable execution of multiple, and possibly 
concurrently executing protocols. 
Section 4 provides details of the TIES and ESMACS protocols and how these have been mapped 
to teh abstractions underlying HTBAC. 
In Sections 5 and 6 we describe the design and then results of a series of experiments 
characterizing the performance and scalability of HTBAC on the Blue Waters and Titan 
supercomputers.
We conclude with a discussion of the impact of HTBAC, implications for binding
affinity calculations and near-term future work.
